@page "/{sessionId?}"
@using Microsoft.AspNetCore.SignalR.Client
@using SSLValidator.Shared
@inject HttpClient Http
@inject IJSRuntime JS
@inject NavigationManager NavigationManager
@implements IAsyncDisposable


@if (domains == null)
{
	<p class="text-center"><em>Loading...</em></p>
}
else
{
	<h2 class="marquee">
	<span>
		<h1></h1>
	</span>
</h2>
	<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-xl">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="exampleModalLabel">Modal title</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<table class="table">
					<thead>
						<tr>
							<th>Domain Name</th>
							<th>Domain Url</th>
							<th>Days until expired</th>
							<th>Threat level</th>
						</tr>
					</thead>
					<tbody>
						@foreach (var domain in domains)
							{
								<tr>
									<td>@domain.DomainName</td>
									<td>@domain.Url</td>
									<td>@domain.DaysUntilExpiration</td>
									<td>@domain.ThreatLevel</td>
								</tr>
							}
						</tbody>
					</table>

				</div>
				<div class="modal-footer">
					<div class="d-flex justify-content-between w-100">
						<button type="button" class="btn btn-outline-success rounded-0">Add Domain</button>
						<div>
							<button type="button" class="btn btn-outline-danger rounded-0"
							data-bs-dismiss="modal">Close</button>
							<button type="button" class="btn btn-primary rounded-0">Save changes</button>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
}

@code {
	private IJSObjectReference? module;
	private string? result;
	private List<Domain>? domains;
	private HubConnection? hubConnection;

	[Parameter]
	public string? SessionId { get; set; }

	protected override async Task OnInitializedAsync()
	{
		if (SessionId is null)
		{
			var sessionIdPath = await Http.GetStringAsync("Domain/GetSessionId");
			NavigationManager.NavigateTo("/" + sessionIdPath);
		}

		hubConnection = new HubConnectionBuilder()
		.WithUrl(NavigationManager.ToAbsoluteUri("/domainhub"))
		.Build();

		hubConnection.On<List<Domain>>("ReceiveCurrentDomains", (currentDomains) =>
		{
			domains = currentDomains;
			StateHasChanged();
		});

		await hubConnection.StartAsync();
	}

	public async ValueTask DisposeAsync()
	{
		if (hubConnection is not null)
		{
			await hubConnection.DisposeAsync();
		}
	}

	protected override async Task OnAfterRenderAsync(bool firstRender)
	{
		if (firstRender)
		{
			module = await JS.InvokeAsync<IJSObjectReference>("import", "./js/index.js");
			if (hubConnection is not null)
			{
				await hubConnection.SendAsync("GetCurrentDomains", SessionId);
			}
		}
	}

	public async Task GetSomeDomains()
	{
		if (hubConnection is not null)
		{
			await hubConnection.SendAsync("GetCurrentDomains", SessionId);
		}
	}

	private async Task TriggerPrompt()
	{
		result = await Prompt("Provide some text");
	}

	public async ValueTask<string?> Prompt(string message) =>
	module is not null ?
	await module.InvokeAsync<string>("showPrompt", message) : null;
}
